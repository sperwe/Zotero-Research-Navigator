<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>History Tree</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 13px;
            background: var(--material-background, #fff);
            color: var(--fill-primary, #000);
        }
        
        #toolbar {
            display: flex;
            align-items: center;
            padding: 5px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        #toolbar button {
            margin-right: 10px;
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            cursor: pointer;
            border-radius: 3px;
        }
        
        #toolbar button:hover {
            background: #e0e0e0;
        }
        
        #tree-container {
            height: calc(100vh - 60px);
            overflow: auto;
        }
        
        /* è‡ªå®šä¹‰ zTree æ ·å¼ */
        .ztree li span.button.remove {
            margin-left: 5px;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .ztree li span.button.restore {
            margin-left: 5px;
            background: none;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button id="refresh-btn">ğŸ”„ Refresh</button>
        <button id="clear-btn">ğŸ—‘ï¸ Clear All</button>
        <button id="settings-btn">âš™ï¸ Settings</button>
    </div>
    <div id="tree-container" class="ztree"></div>
    
    <!-- åŠ è½½ jQuery å’Œ zTree -->
    <script src="lib/jquery.min.js"></script>
    <script src="lib/ztree/jquery.ztree.core.min.js"></script>
    <link rel="stylesheet" href="lib/ztree/zTreeStyle.css">
    
    <script>
        // å…¨å±€å˜é‡
        let treeObj = null;
        
        // ä¸çˆ¶çª—å£é€šä¿¡çš„ API
        window.historyTreeAPI = {
            // æ„å»ºæ ‘
            buildTree: function(data) {
                const zNodes = convertToZNodes(data);
                
                const setting = {
                    view: {
                        dblClickExpand: true,
                        showLine: true,
                        showIcon: true,
                        nameIsHTML: true,
                        addDiyDom: addCustomButtons
                    },
                    data: {
                        simpleData: {
                            enable: true,
                            idKey: "id",
                            pIdKey: "pId"
                        }
                    },
                    callback: {
                        onClick: handleNodeClick,
                        onRightClick: handleNodeRightClick
                    }
                };
                
                treeObj = $.fn.zTree.init($("#tree-container"), setting, zNodes);
            },
            
            // åˆ·æ–°æ ‘
            refresh: function() {
                if (window.parent && window.parent.refreshHistoryTree) {
                    window.parent.refreshHistoryTree();
                }
            },
            
            // è·å–æ ‘å¯¹è±¡
            getTree: function() {
                return treeObj;
            }
        };
        
        // è½¬æ¢æ•°æ®ä¸º zTree èŠ‚ç‚¹æ ¼å¼
        function convertToZNodes(data) {
            const zNodes = [];
            const { dateGroups, closedTabs } = data;
            
            // å¤„ç†æ—¥æœŸåˆ†ç»„
            dateGroups.forEach(([date, sessionData]) => {
                // åˆ›å»ºæ—¥æœŸèŠ‚ç‚¹
                const dateNode = {
                    id: `date_${date}`,
                    pId: null,
                    name: `ğŸ“… ${date}`,
                    open: true,
                    isParent: true
                };
                zNodes.push(dateNode);
                
                // å¤„ç†è¯¥æ—¥æœŸä¸‹çš„ sessions
                sessionData.forEach(({ session, nodes }) => {
                    const sessionNode = {
                        id: `session_${session.id}`,
                        pId: `date_${date}`,
                        name: `ğŸ“š Session ${session.id.slice(-6)}`,
                        title: `${nodes.length} items`,
                        open: false,
                        isParent: true,
                        sessionData: session
                    };
                    zNodes.push(sessionNode);
                    
                    // æ·»åŠ å­èŠ‚ç‚¹
                    nodes.forEach(node => {
                        const nodeIcon = node.status === 'active' ? 'ğŸ“–' : 'ğŸ“•';
                        const historyNode = {
                            id: `node_${node.id}`,
                            pId: `session_${session.id}`,
                            name: `${nodeIcon} ${node.title || 'Untitled'}`,
                            title: `Visited at ${new Date(node.timestamp).toLocaleTimeString()}`,
                            historyNode: node
                        };
                        zNodes.push(historyNode);
                    });
                });
            });
            
            // å¤„ç†å…³é—­çš„æ ‡ç­¾
            if (closedTabs && closedTabs.length > 0) {
                const closedTabsNode = {
                    id: 'closed_tabs',
                    pId: null,
                    name: `ğŸ‘» Closed Tabs (${closedTabs.length})`,
                    open: true,
                    isParent: true
                };
                zNodes.push(closedTabsNode);
                
                closedTabs.forEach((tab, index) => {
                    const closedNode = {
                        id: `closed_${index}`,
                        pId: 'closed_tabs',
                        name: `ğŸ‘» ${tab.node.title || 'Untitled'}`,
                        title: `Closed at ${tab.closedAt.toLocaleTimeString()}`,
                        closedTabData: tab
                    };
                    zNodes.push(closedNode);
                });
            }
            
            return zNodes;
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æŒ‰é’®
        function addCustomButtons(treeId, treeNode) {
            const aObj = $("#" + treeNode.tId + "_a");
            
            if (treeNode.historyNode) {
                // æ·»åŠ åˆ é™¤æŒ‰é’®
                const deleteBtn = $('<span class="button remove">ğŸ—‘ï¸</span>');
                deleteBtn.on('click', function(e) {
                    e.stopPropagation();
                    if (window.parent && window.parent.deleteHistoryNode) {
                        window.parent.deleteHistoryNode(treeNode.historyNode.id);
                    }
                });
                aObj.append(deleteBtn);
            }
            
            if (treeNode.closedTabData) {
                // æ·»åŠ æ¢å¤æŒ‰é’®
                const restoreBtn = $('<span class="button restore">â†©ï¸</span>');
                restoreBtn.on('click', function(e) {
                    e.stopPropagation();
                    if (window.parent && window.parent.restoreClosedTab) {
                        window.parent.restoreClosedTab(treeNode.closedTabData);
                    }
                });
                aObj.append(restoreBtn);
            }
        }
        
        // å¤„ç†èŠ‚ç‚¹ç‚¹å‡»
        function handleNodeClick(event, treeId, treeNode) {
            if (window.parent && window.parent.handleHistoryNodeClick) {
                window.parent.handleHistoryNodeClick(treeNode);
            }
        }
        
        // å¤„ç†å³é”®ç‚¹å‡»
        function handleNodeRightClick(event, treeId, treeNode) {
            if (window.parent && window.parent.handleHistoryNodeRightClick) {
                window.parent.handleHistoryNodeRightClick(event, treeNode);
            }
        }
        
        // å·¥å…·æ æŒ‰é’®äº‹ä»¶
        document.getElementById('refresh-btn').addEventListener('click', function() {
            window.historyTreeAPI.refresh();
        });
        
        document.getElementById('clear-btn').addEventListener('click', function() {
            if (window.parent && window.parent.clearAllHistory) {
                window.parent.clearAllHistory();
            }
        });
        
        document.getElementById('settings-btn').addEventListener('click', function() {
            if (window.parent && window.parent.showHistorySettings) {
                window.parent.showHistorySettings();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåé€šçŸ¥çˆ¶çª—å£
        window.addEventListener('load', function() {
            if (window.parent && window.parent.onHistoryTreeReady) {
                window.parent.onHistoryTreeReady();
            }
        });
    </script>
</body>
</html>