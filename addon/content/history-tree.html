<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>History Tree</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 13px;
            background: var(--material-background, #fff);
            color: var(--fill-primary, #000);
        }
        
        #toolbar {
            display: flex;
            align-items: center;
            padding: 5px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        #toolbar button {
            margin-right: 10px;
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            cursor: pointer;
            border-radius: 3px;
        }
        
        #toolbar button:hover {
            background: #e0e0e0;
        }
        
        #tree-container {
            height: calc(100vh - 60px);
            overflow: auto;
        }
        
        /* 自定义 zTree 样式 */
        .ztree li span.button.remove {
            margin-left: 5px;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .ztree li span.button.restore {
            margin-left: 5px;
            background: none;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button id="refresh-btn">🔄 Refresh</button>
        <button id="clear-btn">🗑️ Clear All</button>
        <button id="settings-btn">⚙️ Settings</button>
    </div>
    <div id="tree-container" class="ztree"></div>
    
    <!-- 加载 jQuery 和 zTree -->
    <script src="lib/jquery.min.js"></script>
    <script src="lib/ztree/jquery.ztree.core.min.js"></script>
    <link rel="stylesheet" href="lib/ztree/zTreeStyle.css">
    
    <script>
        // 全局变量
        let treeObj = null;
        
        // 与父窗口通信的 API
        window.historyTreeAPI = {
            // 构建树
            buildTree: function(data) {
                const zNodes = convertToZNodes(data);
                
                const setting = {
                    view: {
                        dblClickExpand: true,
                        showLine: true,
                        showIcon: true,
                        nameIsHTML: true,
                        addDiyDom: addCustomButtons
                    },
                    data: {
                        simpleData: {
                            enable: true,
                            idKey: "id",
                            pIdKey: "pId"
                        }
                    },
                    callback: {
                        onClick: handleNodeClick,
                        onRightClick: handleNodeRightClick
                    }
                };
                
                treeObj = $.fn.zTree.init($("#tree-container"), setting, zNodes);
            },
            
            // 刷新树
            refresh: function() {
                if (window.parent && window.parent.refreshHistoryTree) {
                    window.parent.refreshHistoryTree();
                }
            },
            
            // 获取树对象
            getTree: function() {
                return treeObj;
            }
        };
        
        // 转换数据为 zTree 节点格式
        function convertToZNodes(data) {
            const zNodes = [];
            const { dateGroups, closedTabs } = data;
            
            // 处理日期分组
            dateGroups.forEach(([date, sessionData]) => {
                // 创建日期节点
                const dateNode = {
                    id: `date_${date}`,
                    pId: null,
                    name: `📅 ${date}`,
                    open: true,
                    isParent: true
                };
                zNodes.push(dateNode);
                
                // 处理该日期下的 sessions
                sessionData.forEach(({ session, nodes }) => {
                    const sessionNode = {
                        id: `session_${session.id}`,
                        pId: `date_${date}`,
                        name: `📚 Session ${session.id.slice(-6)}`,
                        title: `${nodes.length} items`,
                        open: false,
                        isParent: true,
                        sessionData: session
                    };
                    zNodes.push(sessionNode);
                    
                    // 添加子节点
                    nodes.forEach(node => {
                        const nodeIcon = node.status === 'active' ? '📖' : '📕';
                        const historyNode = {
                            id: `node_${node.id}`,
                            pId: `session_${session.id}`,
                            name: `${nodeIcon} ${node.title || 'Untitled'}`,
                            title: `Visited at ${new Date(node.timestamp).toLocaleTimeString()}`,
                            historyNode: node
                        };
                        zNodes.push(historyNode);
                    });
                });
            });
            
            // 处理关闭的标签
            if (closedTabs && closedTabs.length > 0) {
                const closedTabsNode = {
                    id: 'closed_tabs',
                    pId: null,
                    name: `👻 Closed Tabs (${closedTabs.length})`,
                    open: true,
                    isParent: true
                };
                zNodes.push(closedTabsNode);
                
                closedTabs.forEach((tab, index) => {
                    const closedNode = {
                        id: `closed_${index}`,
                        pId: 'closed_tabs',
                        name: `👻 ${tab.node.title || 'Untitled'}`,
                        title: `Closed at ${tab.closedAt.toLocaleTimeString()}`,
                        closedTabData: tab
                    };
                    zNodes.push(closedNode);
                });
            }
            
            return zNodes;
        }
        
        // 添加自定义按钮
        function addCustomButtons(treeId, treeNode) {
            const aObj = $("#" + treeNode.tId + "_a");
            
            if (treeNode.historyNode) {
                // 添加删除按钮
                const deleteBtn = $('<span class="button remove">🗑️</span>');
                deleteBtn.on('click', function(e) {
                    e.stopPropagation();
                    if (window.parent && window.parent.deleteHistoryNode) {
                        window.parent.deleteHistoryNode(treeNode.historyNode.id);
                    }
                });
                aObj.append(deleteBtn);
            }
            
            if (treeNode.closedTabData) {
                // 添加恢复按钮
                const restoreBtn = $('<span class="button restore">↩️</span>');
                restoreBtn.on('click', function(e) {
                    e.stopPropagation();
                    if (window.parent && window.parent.restoreClosedTab) {
                        window.parent.restoreClosedTab(treeNode.closedTabData);
                    }
                });
                aObj.append(restoreBtn);
            }
        }
        
        // 处理节点点击
        function handleNodeClick(event, treeId, treeNode) {
            if (window.parent && window.parent.handleHistoryNodeClick) {
                window.parent.handleHistoryNodeClick(treeNode);
            }
        }
        
        // 处理右键点击
        function handleNodeRightClick(event, treeId, treeNode) {
            if (window.parent && window.parent.handleHistoryNodeRightClick) {
                window.parent.handleHistoryNodeRightClick(event, treeNode);
            }
        }
        
        // 工具栏按钮事件
        document.getElementById('refresh-btn').addEventListener('click', function() {
            window.historyTreeAPI.refresh();
        });
        
        document.getElementById('clear-btn').addEventListener('click', function() {
            if (window.parent && window.parent.clearAllHistory) {
                window.parent.clearAllHistory();
            }
        });
        
        document.getElementById('settings-btn').addEventListener('click', function() {
            if (window.parent && window.parent.showHistorySettings) {
                window.parent.showHistorySettings();
            }
        });
        
        // 页面加载完成后通知父窗口
        window.addEventListener('load', function() {
            if (window.parent && window.parent.onHistoryTreeReady) {
                window.parent.onHistoryTreeReady();
            }
        });
    </script>
</body>
</html>